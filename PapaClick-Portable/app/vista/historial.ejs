<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= titulo %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navegación -->
    <%- include('partials/navbar') %>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Panel de estadísticas -->
            <div class="col-md-4 mb-4">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-graph-up"></i> Mis Estadísticas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h3 class="text-primary"><%= estadisticas.total || 0 %></h3>
                                <p class="text-muted mb-0">Total Clasificaciones</p>
                            </div>
                            <div class="col-6">
                                <h3 class="text-success"><%= estadisticas.confianzaPromedio ? (estadisticas.confianzaPromedio * 100).toFixed(1) + '%' : '0%' %></h3>
                                <p class="text-muted mb-0">Confianza Promedio</p>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Estadísticas rápidas por condición -->
                        <div id="estadisticasRapidas" class="mt-3">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel principal -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clock-history"></i> Mi Historial de Clasificaciones
                        </h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse">
                                <i class="bi bi-funnel"></i> Filtros
                            </button>
                        </div>
                    </div>

                    <!-- Panel de filtros colapsable -->
                    <div class="collapse <%= Object.keys(filtros || {}).length > 0 ? 'show' : '' %>" id="filtrosCollapse">
                        <div class="card-body border-bottom">
                            <form method="GET" class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Variedad</label>
                                    <select name="variedad" class="form-select form-select-sm">
                                        <option value="todas" <%= (!filtros.variedad || filtros.variedad === 'todas') ? 'selected' : '' %>>Todas</option>
                                        <% variedades.forEach(function(variedad) { %>
                                            <option value="<%= variedad.nombreComun %>" <%= filtros.variedad === variedad.nombreComun ? 'selected' : '' %>>
                                                <%= variedad.nombreComun %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Condición</label>
                                    <select name="condicion" class="form-select form-select-sm">
                                        <option value="todas" <%= (!filtros.condicion || filtros.condicion === 'todas') ? 'selected' : '' %>>Todas</option>
                                        <option value="apto" <%= filtros.condicion === 'apto' ? 'selected' : '' %>>Apto</option>
                                        <option value="no apto" <%= filtros.condicion === 'no apto' ? 'selected' : '' %>>No Apto</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Estado</label>
                                    <select name="estado" class="form-select form-select-sm">
                                        <option value="todas" <%= (!filtros.estado || filtros.estado === 'todas') ? 'selected' : '' %>>Todos</option>
                                        <option value="procesada" <%= filtros.estado === 'procesada' ? 'selected' : '' %>>Procesada</option>
                                        <option value="validada" <%= filtros.estado === 'validada' ? 'selected' : '' %>>Validada</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary btn-sm me-2">
                                        <i class="bi bi-search"></i> Filtrar
                                    </button>
                                    <a href="/historial" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-x-lg"></i> Limpiar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card-body">
                        <% if (clasificaciones && clasificaciones.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Variedad</th>
                                            <th>Condición</th>
                                            <th>Confianza</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% clasificaciones.forEach(function(clasificacion) { %>
                                            <tr>
                                                <td>
                                                    <small class="text-muted">
                                                        <%= new Date(clasificacion.fechaClasificacion).toLocaleDateString('es-ES') %><br>
                                                        <%= new Date(clasificacion.fechaClasificacion).toLocaleTimeString('es-ES') %>
                                                    </small>
                                                </td>
                                                <td>
                                                    <strong><%= clasificacion.idVariedad ? clasificacion.idVariedad.nombreComun : 'N/A' %></strong>
                                                </td>
                                                <td>
                                                    <% if (clasificacion.condicion === 'apto') { %>
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-check-circle"></i> Apto
                                                        </span>
                                                    <% } else { %>
                                                        <span class="badge bg-warning text-dark">
                                                            <i class="bi bi-exclamation-triangle"></i> No Apto
                                                        </span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="progress me-2" style="width: 60px; height: 8px;">
                                                            <div class="progress-bar <%= clasificacion.confianza >= 0.8 ? 'bg-success' : (clasificacion.confianza >= 0.6 ? 'bg-warning' : 'bg-danger') %>" 
                                                                 style="width: <%= (clasificacion.confianza * 100).toFixed(0) %>%"></div>
                                                        </div>
                                                        <small><%= (clasificacion.confianza * 100).toFixed(1) %>%</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    <% if (clasificacion.estado === 'validada') { %>
                                                        <span class="badge bg-primary">
                                                            <i class="bi bi-shield-check"></i> Validada
                                                        </span>
                                                    <% } else { %>
                                                        <span class="badge bg-secondary">
                                                            <i class="bi bi-clock"></i> Procesada
                                                        </span>
                                                    <% } %>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Paginación -->
                            <% if (paginacion && paginacion.totalPages > 1) { %>
                                <nav aria-label="Navegación del historial">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item <%= !paginacion.hasPrevPage ? 'disabled' : '' %>">
                                            <a class="page-link" href="?page=<%= paginacion.prevPage %>">Anterior</a>
                                        </li>
                                        
                                        <% for (let i = 1; i <= paginacion.totalPages; i++) { %>
                                            <li class="page-item <%= paginacion.currentPage === i ? 'active' : '' %>">
                                                <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                                            </li>
                                        <% } %>
                                        
                                        <li class="page-item <%= !paginacion.hasNextPage ? 'disabled' : '' %>">
                                            <a class="page-link" href="?page=<%= paginacion.nextPage %>">Siguiente</a>
                                        </li>
                                    </ul>
                                </nav>
                            <% } %>

                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="bi bi-inbox display-1 text-muted"></i>
                                <h5 class="text-muted mt-3">No hay clasificaciones</h5>
                                <p class="text-muted">Comienza clasificando algunas papas para ver tu historial aquí.</p>
                                <a href="/clasificacion" class="btn btn-primary">
                                    <i class="bi bi-camera"></i> Clasificar Papa
                                </a>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cargar estadísticas rápidas
        document.addEventListener('DOMContentLoaded', function() {
            cargarEstadisticasRapidas();
        });

        async function cargarEstadisticasRapidas() {
            try {
                const response = await fetch('/historial/estadisticas');
                const data = await response.json();
                
                if (data.success) {
                    mostrarEstadisticasRapidas(data.estadisticas);
                } else {
                    document.getElementById('estadisticasRapidas').innerHTML = 
                        '<p class="text-muted text-center">No hay datos disponibles</p>';
                }
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
                document.getElementById('estadisticasRapidas').innerHTML = 
                    '<p class="text-danger text-center">Error cargando estadísticas</p>';
            }
        }

        function mostrarEstadisticasRapidas(estadisticas) {
            let html = '';
            
            estadisticas.forEach(est => {
                html += `
                    <div class="mb-3">
                        <h6 class="text-capitalize">${est._id}</h6>
                        <div class="row g-2">
                `;
                
                est.condiciones.forEach(cond => {
                    const colorClass = cond.condicion === 'apto' ? 'success' : 'warning';
                    html += `
                        <div class="col-6">
                            <div class="card card-body text-center p-2 border-${colorClass}">
                                <small class="text-${colorClass} fw-bold">${cond.condicion.toUpperCase()}</small>
                                <strong>${cond.cantidad}</strong>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            if (html === '') {
                html = '<p class="text-muted text-center">No hay clasificaciones aún</p>';
            }
            
            document.getElementById('estadisticasRapidas').innerHTML = html;
        }
    </script>
</body>
</html>